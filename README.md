# grafana-file-datasource

Grafana-плагин и сервер для подключения внещних файлов к графане. 

Поддерживаемые на текущий момент типы:
* CSV

## 1 Установка

Про установку графаны можно посмотреть [здесь](https://grafana.com/docs/grafana/latest/installation/requirements/ ).


### 1.1 Grafana

Весь проект был создан и запущен на Windows Subsystem for Linux.

Для установки grafana в Ubuntu/Debian можно воспользоваться следующим кодом:
```
sudo apt-get install -y apt-transport-https
sudo apt-get install -y software-properties-common wget
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -

# Alternatively you can add the beta repository, see in the table above
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"

sudo apt-get update
sudo apt-get install grafana
```
**Примечание:** У графаны под виндой странные траблы с плагинами - он их не видел. Возможно, мой косяк, я особо смотрел :/

### 1.2 Plugin

Для установки плагина достаточно просто скопировать папку ```modified-json``` в папку с плагинами. Я просто сделал текущую папку папкой с плагинами.
Для этого я добавил в файл ```/etc/grafana/grafana.ini``` строчку (моя папка называлась grafana-linux):
```
plugins = '/mnt/c/grafana-linux/'
```

Про располажение файл и сам файл можно почитать [здесь]( https://grafana.com/docs/grafana/latest/administration/configuration/#plugins ).

Про оригинальный JSON плагин можно почитать [здесь] ( https://grafana.com/grafana/plugins/simpod-json-datasource ).

### 1.3 Python

Сервер работает на python3. Необходимые пакеты можно установить командой ниже:
```
pip3 install flask flask-cors numpy pandas sklearn
```

## 2 Запуск

Для начала следует запустить сервер. Он запускается следующей командой:
```
sudo python3 PythonServer.py -f ./folders/
```

С флагом -f скрипт принимает папку, в которой находятся другие папки, в которых уже и находятся файлы.
Т.е. в папке ```folders```  находится в моем примере папка ```sample```, в которой уже и находятся файлы.

Такая структура нужна для того, чтобы можно было подключать несколько папок как отдельные источники в графане.

Сама графана запускается так:
```
sudo service grafana-server start
```

## 3 Grafana Configuration

Для начала создается Datasouce через плагин JSON. В качестве ссылки используется адрес нашего бэкенда + папки в folders: ```http://localhost:3003/sample/````. 
Имя назначается любым, я назначил Sample. Если в этой папке есть файлы, то при нажатии Save&Test будет все ОК.

Далее можно создать свою панель на вкладке дашбордов (большая кнопка +), чтобы потестить графану, а можно загрузить мой дашборд через импорт там же.
Мой дашборд работает с data.csv файлом. На текущий момент, специальные метрики жестко привязаны к тем названиям колонок.

## 4 Dashboard Configuration

Для фильтрации по датам есть плашка справа вверху. Можно также фильтровать, выделяя конкретный период мышкой прямо на графике. Фильтр применяется сразу ко всем панелям.

Панель обращается к выбранному над полем запроса источнику через query, который возвращает в моем случае JSON, слепленный из датафрейма пандаса. 
В запросе надо указать тип результата (Timeseries всегда лучше оставлять, Table не используется пока нигде нормально), файл (файл в sample у меня) и 
метрика (колонки датафрейма и специальные захардкоженные метрики). Запросов может быть несколько, тогда на графике будет несколько линий.

Фильтрации кроме как по дате пока нет.

## 5 Python сервер

Сервер работает на фласке. Конкретно файл PythonServer.py работает с QueryHandler-ом, классов обработчика запросов. В файле есть интерфейс, который должен быть реализован
для работы. Мой QueryHandler работает с классами FileHandler. Я реализовал CSVHandler, там есть общий интерфейс, с которым работает QueryHandler, поэтому добавить
новый тип файлом по идее не должно быть сложно, т.к. FileHandler должен отдавать pd.DataFrame.

